# =============================================================================
# Claude Code Tool Permissions Configuration
# =============================================================================
#
# This file controls which tool calls Claude Code can execute automatically,
# which require user approval, and which are blocked entirely.
#
# Location: .claude/hooks/tool_permissions.yaml
#
# =============================================================================
# IMPORTANT: RULE ORDERING MATTERS!
# =============================================================================
#
# Rules are processed IN ORDER, and the FIRST MATCHING RULE WINS.
# This means:
#
#   ✓ CORRECT: Specific rules BEFORE general rules
#      1. Block echo with > redirection (specific)
#      2. Allow echo (general)
#
#   ✗ WRONG: General rules before specific rules
#      1. Allow echo (general) - matches first, specific rule never reached!
#      2. Block echo with > redirection (never reached)
#
# Common patterns for rule ordering:
#
#   1. DENY rules first (highest priority - block dangerous operations)
#   2. Specific ALLOW rules (override denies for safe cases)
#   3. General ALLOW rules (broad categories)
#   4. ASK rules last (fallback for uncertain cases)
#
# Examples of good rule ordering:
#
#   # find command rules (specific to general):
#   1. Allow: find -exec grep    (very specific, safe)
#   2. Ask:   find -exec *       (broader, potentially dangerous)
#   3. Allow: find               (general find without -exec)
#
#   # git command rules (deny, then allow):
#   1. Deny:  git add -A         (dangerous pattern)
#   2. Deny:  git push --force   (dangerous pattern)
#   3. Allow: git status         (safe read operation)
#   4. Allow: git commit         (safe write operation)
#
# =============================================================================
# COMMON PATTERNS
# =============================================================================
#
# Pattern: Allow command except with dangerous arguments
#   - name: "Block dangerous usage"
#     command_pattern: "^command$"
#     argument_pattern: ".*dangerous-flag.*"
#     decision: deny
#   - name: "Allow safe usage"
#     command_pattern: "^command$"
#     decision: allow
#
# Pattern: Different treatment based on arguments
#   - name: "Allow with safe args"
#     command_pattern: "^git$"
#     argument_pattern: "^(status|log|diff).*"
#     decision: allow
#   - name: "Ask for risky args"
#     command_pattern: "^git$"
#     argument_pattern: "^(push|commit).*"
#     decision: ask
#
# Pattern: Runtime condition checking
#   - name: "Allow if path exists"
#     command_pattern: "^mkdir$"
#     precondition_script: |
#       DIR=$(echo "{ARGS}" | awk '{print $1}')
#       [ -d "$DIR" ] && echo "allow" || echo "ask"
#
# =============================================================================
# CATEGORIES
# =============================================================================
#
# Commands/tools are categorized as:
#   - read:  Only reads data (grep, ls, git status, Read tool)
#   - write: Modifies data (rm, git commit, Write tool, Edit tool)
#   - other: Everything else (build tools, network operations)
#
# Categories have default behaviors (see "defaults" section below)
#
# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

logging:
  enabled: true
  log_file: "~/inavflight/.claude/hooks/tool_permissions.log"  # Project-local log file
  log_inputs: true     # Log incoming hook JSON
  log_outputs: true    # Log hook decisions
  max_log_size_mb: 10  # Rotate log when it exceeds this size


# =============================================================================
# DEFAULT PERMISSIONS BY CATEGORY
# =============================================================================
# These apply when no specific rule matches.
# Options: "allow", "deny", "ask"

defaults:
  read: allow      # Tools/commands that only read data (Read, Glob, Grep, git status, etc.)
  write: ask       # Tools/commands that modify data (Write, Edit, git commit, etc.)
  other: ask       # Everything else

# =============================================================================
# GENERAL TOOL RULES (Non-Bash Tools)
# =============================================================================
# Rules for Claude Code tools like Read, Write, Edit, TodoWrite, Skill, etc.
#
# Processing: First match wins
#
# Fields:
#   - name: Human-readable description (for logging)
#   - tool_name_pattern: Regex matching tool name (e.g., "^Bash$", "^(Read|Write)$")
#   - tool_input_patterns: Dict of regex patterns matching tool input fields
#   - category: "read", "write", or "other" (affects default if decision not specified)
#   - decision: "allow", "deny", or "ask" (optional if relying on category default)
#   - message: Message shown to user/Claude when denying or asking

rules:
  # ===================================================================
  # Always-Allow Tools (Task Management, Skills, Read Operations)
  # ===================================================================

  - name: "Allow TodoWrite for task tracking"
    tool_name_pattern: "^TodoWrite$"
    category: other
    decision: allow

  - name: "Allow TaskOutput for retrieving task results"
    tool_name_pattern: "^TaskOutput$"
    category: read
    decision: allow

  - name: "Allow Skill tool (always allow skills)"
    tool_name_pattern: "^Skill$"
    category: other
    decision: allow

  - name: "Allow read-only file operations"
    tool_name_pattern: "^(Read|Glob|Grep)$"
    category: read
    decision: allow

  - name: "Allow web operations"
    tool_name_pattern: "^(WebSearch|WebFetch)$"
    category: read
    decision: allow

  - name: "Allow Chrome DevTools MCP tools"
    tool_name_pattern: "^mcp__chrome-devtools__.*$"
    category: other
    decision: allow

  # ===================================================================
  # Deny Rules (Dangerous Patterns)
  # ===================================================================

  - name: "Block git add -A"
    tool_name_pattern: "^Bash$"
    tool_input_patterns:
      command: "git add -A"
    category: write
    decision: deny
    message: "git add -A is not allowed. Please add files explicitly."

  - name: "Block Write/Edit to wrong claude paths"
    tool_name_pattern: "^(Write|Edit)$"
    tool_input_patterns:
      file_path: ".*(inav/claude|inav-configurator/claude|inavwiki/claude).*"
    category: write
    decision: deny
    message: "STOP! The claude/ directory is at /home/raymorris/Documents/planes/inavflight/claude/ (or ~/inavflight/claude/), NOT inside inav/, inav-configurator/, or inavwiki/. Use the correct path: /home/raymorris/Documents/planes/inavflight/claude/ or ~/inavflight/claude/"

  # ===================================================================
  # Allow Rules (Safe File Modifications)
  # ===================================================================

  - name: "Allow editing tool permissions configuration"
    tool_name_pattern: "^(Write|Edit)$"
    tool_input_patterns:
      file_path: ".*tool_permissions\\.yaml.*"
    category: write
    decision: allow

  # ===================================================================
  # Ask Rules (File Modifications)
  # ===================================================================

  - name: "Confirm file modifications"
    tool_name_pattern: "^(Write|Edit)$"
    category: write
    decision: ask
    message: "File modification requested"

# =============================================================================
# BASH-SPECIFIC RULES
# =============================================================================
# Special rules for Bash tool that parse compound commands into subcommands.
# Each subcommand is analyzed as "command" + "arguments".
#
# Processing: First match wins (even more important here!)
#
# Fields:
#   - name: Human-readable description
#   - command_pattern: Regex matching the command part (e.g., "^git$", "^rm$")
#   - argument_pattern: Regex matching the arguments (optional)
#   - category: "read", "write", or "other"
#   - decision: "allow", "deny", or "ask"
#   - message: Message for deny/ask decisions
#   - precondition_script: Optional bash script that returns "allow", "deny", or "ask"
#                          based on runtime conditions (e.g., check if path exists)
#                          Available variables: {COMMAND}, {ARGS}, {FULL_COMMAND}

bash_rules:
  # ===================================================================
  # Path Safety Rules (Project-Specific)
  # ===================================================================
  # IMPORTANT: These must come first to catch dangerous patterns early

  - name: "Block mkdir to wrong claude paths"
    command_pattern: "^mkdir$"
    argument_pattern: ".*(inav/claude|inav-configurator/claude|inavwiki/claude).*"
    category: write
    decision: deny
    message: "STOP! The claude/ directory is at /home/raymorris/Documents/planes/inavflight/claude/ (or ~/inavflight/claude/), NOT inside inav/, inav-configurator/, or inavwiki/. Use the correct path when creating directories."

  - name: "Block cp/mv to wrong claude paths"
    command_pattern: "^(cp|mv)$"
    argument_pattern: ".*(inav/claude|inav-configurator/claude|inavwiki/claude).*"
    category: write
    decision: deny
    message: "STOP! The claude/ directory is at /home/raymorris/Documents/planes/inavflight/claude/ (or ~/inavflight/claude/), NOT inside inav/, inav-configurator/, or inavwiki/. Use the correct destination path."

  # ===================================================================
  # Git Safety Rules
  # ===================================================================
  # IMPORTANT: Deny rules MUST come before allow rules
  # Order: deny (highest priority) → specific allow → general allow

  - name: "Block git add -A"
    command_pattern: "^git$"
    argument_pattern: "^(-C\\s+\\S+\\s+)?add -A"
    category: write
    decision: deny
    message: "STOP! IMPORTANT: Do NOT run 'git add -A'. Add the specific files you actually want."

  - name: "Block git push to maintenance/master"
    command_pattern: "^git$"
    argument_pattern: "^(-C\\s+\\S+\\s+)?push.*(maintenance|master).*"
    category: write
    decision: deny
    message: "STOP! IMPORTANT: Do NOT push to a version branch (maintenance-9.x, maintenance-10.x) or to master (except for inavwiki). Use your create-pr skill with a feature branch."

  - name: "Block git force push"
    command_pattern: "^git$"
    argument_pattern: "^(-C\\s+\\S+\\s+)?push.*force.*"
    category: write
    decision: deny
    message: "STOP! IMPORTANT: Do NOT force push! That will break public history!"

  # Git read operations (safe)
  - name: "Allow git read operations"
    command_pattern: "^git$"
    argument_pattern: "^(-c\\s+safe\\.directory=\\S+\\s+)?(-C\\s+\\S+\\s+)?(status|log|diff|show|branch|remote|describe|rev-parse|rev-list|cat-file|ls-tree|ls-files|grep|merge-base|blame|tag).*"
    category: read
    decision: allow

  - name: "Allow git fetch"
    command_pattern: "^git$"
    argument_pattern: "^(-c\\s+safe\\.directory=\\S+\\s+)?(-C\\s+\\S+\\s+)?fetch.*"
    category: read
    decision: allow

  - name: "Allow git pull"
    command_pattern: "^git$"
    argument_pattern: "^(-C\\s+\\S+\\s+)?pull.*"
    category: write
    decision: allow

  - name: "Allow git checkout/stash/cherry-pick"
    command_pattern: "^git$"
    argument_pattern: "^(-C\\s+\\S+\\s+)?(checkout|stash|cherry-pick|restore).*"
    category: write
    decision: allow

  - name: "Git commit reminder"
    command_pattern: "^git$"
    argument_pattern: "^(-C\\s+\\S+\\s+)?commit.*"
    category: write
    decision: allow
    message: "Git commit detected - reminder added about not mentioning Claude/AI in commit messages"

  # ===================================================================
  # Find Command Rules
  # ===================================================================
  # IMPORTANT: Specific patterns (find -exec grep) before general (find -exec)
  # Order: allow safe -exec → ask dangerous -exec → allow general find

  - name: "Allow find -exec with read commands"
    command_pattern: "^find$"
    argument_pattern: ".*-exec\\s+(grep|egrep|cat|ls|head|tail|file|stat|wc|diff)\\s+.*"
    category: read
    decision: allow

  - name: "Ask for approval on find -exec (non-read commands)"
    command_pattern: "^find$"
    argument_pattern: ".*-exec.*"
    category: other
    decision: ask
    message: "find with -exec requires approval (can execute arbitrary commands). find -exec with read commands (grep, cat, etc.) is allowed."

  # General find (without -exec) is allowed later in "Allow common read commands"

  # ===================================================================
  # Echo Command Rules
  # ===================================================================
  # IMPORTANT: Block redirected echo BEFORE allowing general echo
  # Order: block echo > file → allow echo

  - name: "Block echo with file redirection"
    command_pattern: "^echo$"
    argument_pattern: ".*>>?.*"
    category: write
    decision: ask
    message: "echo with file redirection requires approval (writes to file)"

  - name: "Allow echo without redirection"
    command_pattern: "^echo$"
    category: read
    decision: allow

  # ===================================================================
  # Cat/Heredoc Write Rules
  # ===================================================================
  # Handle patterns like: cat > file << 'EOF' or cat > file <<EOF

  - name: "Allow cat > to claude/ directories"
    command_pattern: "^cat$"
    argument_pattern: "^>\\s+(claude/|\\./claude/|\\.claude/).*"
    category: write
    decision: allow
    message: "Writing to claude/ directory"

  - name: "Ask for cat > to other locations"
    command_pattern: "^cat$"
    argument_pattern: "(^|\\s)>>?"
    category: write
    decision: ask
    message: "cat with stdout redirection requires approval"

  # ===================================================================
  # Email/Inbox File Operations
  # ===================================================================

  - name: "Allow cp/mv within role email directories"
    command_pattern: "^(cp|mv)$"
    argument_pattern: ".*(claude/(developer|manager)/(inbox|sent|inbox-archive)).*"
    category: write
    decision: allow

  # ===================================================================
  # Safe File Removal
  # ===================================================================

  - name: "Allow rm for SITL temp files"
    command_pattern: "^rm$"
    argument_pattern: ".*eeprom\\.bin.*"
    category: write
    decision: allow

  # ===================================================================
  # Dangerous Recursive Operations
  # ===================================================================

  - name: "Block dangerous recursive operations"
    command_pattern: "^(rm|mv|cp)$"
    argument_pattern: ".*-r.*"
    category: write
    decision: deny
    message: "Recursive file operations require manual approval"

  # ===================================================================
  # Build Tools & Compilers
  # ===================================================================

  - name: "Allow cd (change directory)"
    command_pattern: "^cd$"
    category: read
    decision: allow

  - name: "Allow cmake (build system)"
    command_pattern: "^cmake$"
    category: other
    decision: allow

  - name: "Allow ARM toolchain (arm-none-eabi-*)"
    command_pattern: "^arm-none-eabi-.*$"
    category: other
    decision: allow

  - name: "Allow make (build system)"
    command_pattern: "^make$"
    category: other
    decision: allow

  - name: "Allow dfu-util (device firmware update)"
    command_pattern: "^dfu-util$"
    category: other
    decision: allow

  - name: "Allow build and test commands"
    command_pattern: "^(npm|pip|pio|gcc|g\\+\\+|clang)$"
    argument_pattern: "^(test|build|compile|install|run).*"
    category: other
    decision: allow

  - name: "Allow python3 scripts in claude/ directories"
    command_pattern: "^python3$"
    argument_pattern: ".*(~/inavflight/\\.claude/|\\./\\.claude/|claude/|\\.claude/).*"
    category: other
    decision: allow

  - name: "Allow direct execution of scripts in .claude/skills/"
    command_pattern: ".*(~/inavflight/\\.claude/skills/|/Documents/planes/inavflight/\\.claude/skills/|\\./\\.claude/skills/).*"
    category: other
    decision: allow

  - name: "Allow SITL simulator execution"
    command_pattern: ".*SITL\\.elf$"
    category: other
    decision: allow

  # ===================================================================
  # Common Read-Only Commands (Broad Allow List)
  # ===================================================================
  # These are safe commands that only read/display data

  - name: "Allow common read commands"
    command_pattern: "^(grep|egrep|find|cat|ls|head|tail|less|more|wc|sort|uniq|diff|stat|file|du|df|awk|sed|cut|xargs|printf|pwd|whoami|md5sum|lsusb|sleep|ss)$"
    category: read
    decision: allow

  - name: "Allow file reading"
    command_pattern: "^(rg|fd)$"
    category: read
    decision: allow

  # ===================================================================
  # Shell Control Structures & Parser Artifacts
  # ===================================================================
  # These handle bash syntax elements and parser edge cases

  - name: "Allow shell control structures"
    command_pattern: "^(if|then|else|elif|fi|for|while|do|done|case|esac|break|continue|\\[|\\[\\[|test)$"
    category: read
    decision: allow

  - name: "Ignore redirection operators"
    command_pattern: "^([0-9]>|[0-9]|>>|>)$"
    category: read
    decision: allow

  - name: "Ignore empty/whitespace commands"
    command_pattern: "^\\s*$"
    category: read
    decision: allow

  - name: "Allow -exec arguments from find"
    command_pattern: "^(grep|cat|ls|file|stat)$"
    argument_pattern: ".*"
    category: read
    decision: allow

  # ===================================================================
  # GitHub CLI Commands
  # ===================================================================

  - name: "Allow GitHub CLI read operations"
    command_pattern: "^gh$"
    argument_pattern: "^(pr|issue|run|release|api|workflow).*(list|view|diff|checks|download).*"
    category: read
    decision: allow

  # ===================================================================
  # Runtime Conditional Rules (Using precondition_script)
  # ===================================================================

  - name: "Allow mkdir if directory exists"
    command_pattern: "^mkdir$"
    category: write
    precondition_script: |
      # Extract directory path from arguments (handles -p flag and multiple dirs)
      DIR=$(echo "{ARGS}" | sed 's/^-p *//' | awk '{print $1}')
      if [ -d "$DIR" ]; then
        echo "allow"
      else
        echo "ask"
      fi
