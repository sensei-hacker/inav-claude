# Git Workflow and Best Practices

Detailed git practices for INAV development. For quick reference before committing, see `CRITICAL-BEFORE-COMMIT.md`.

---

## Commits

### Never Use `git add -A`

Review each file individually:
```bash
git status
git diff path/to/file.c
git add path/to/file.c path/to/file.h
```

### Human Review of Commit Messages

**ALWAYS** use editor for commit review:
```bash
GIT_EDITOR="gedit" git commit --edit -m "Your commit message"
```

This allows you to:
- Review the commit message before finalizing
- See the full diff while writing the message
- Make last-minute adjustments

### Commit Message Guidelines

**❌ NEVER:**
- End with "Generated with https://claude.com/claude-code"
- Mention Claude or AI assistance in commit messages
- Use generic messages like "fix bug" or "update code"

**✅ ALWAYS:**
- Focus on WHY, not just WHAT
- Be specific: "Fix blackbox corruption when no motors defined in mixer"
- Keep it concise (1-2 sentences)
- Follow repository's existing commit style (check `git log`)

### Use HEREDOC for Multi-line Messages

```bash
git commit -m "$(cat <<'EOF'
Fix blackbox corruption when no motors defined in mixer

The blackbox logger assumed at least one motor exists.
EOF
)"
```

This ensures:
- Proper formatting of multi-line messages
- No shell escaping issues
- Clean, readable commit messages

### When to Commit

- Prompt user to commit when features are complete
- Don't create commits automatically without user request
- If unclear, ask first

---

## Amending Commits

### Rules for Using `git commit --amend`

**Only use `--amend` when ALL conditions are met:**

1. **HEAD commit was created by you** in this conversation, AND
2. **Commit has NOT been pushed** to remote (verify: `git status` shows "Your branch is ahead"), AND
3. Either:
   - User explicitly requested amend, OR
   - Pre-commit hook auto-modified files that need including

**NEVER amend when:**
- Commit FAILED or was REJECTED by hook (fix issue and create NEW commit)
- Commit has been pushed to remote (requires force push)
- HEAD commit was created by someone else or in a previous session

### Verification Before Amend

```bash
# Check who created the last commit
git log -1 --format='%an %ae'

# Check if commit has been pushed
git status  # Look for "Your branch is ahead of 'origin/...'"
```

---

## Branches

### Never Merge to Master Locally

**Never** merge another branch to master, except by pulling from a remote repo.

```bash
# ❌ NEVER do this:
git checkout master
git merge feature-branch

# ✅ Instead:
# Create PR and let maintainers merge on GitHub
```

### Branch Naming

Use descriptive branch names:
- `fix/issue-1234-blackbox-corruption`
- `feature/improved-motor-wizard`
- `refactor/pid-controller-cleanup`

### Creating Branches

Always create from the correct base branch:

```bash
# For INAV (backward-compatible changes)
git checkout -b fix/issue-1234 upstream/maintenance-9.x

# For INAV (breaking changes)
git checkout -b feature/new-msp upstream/maintenance-10.x

# For PrivacyLRS
git checkout -b fix/issue-42 secure_01
```

See `.claude/skills/git-workflow/SKILL.md` and `.claude/skills/start-task/SKILL.md` for complete branching instructions.

---

## Pull Requests

### After Creating PR

**Wait 3 minutes**, then check the PR for bot suggestions:

```bash
# Use check-pr-bots agent
Task tool with subagent_type="check-pr-bots"
Prompt: "Check PR #11220 for bot comments"

# Or use check-builds skill
/check-builds
```

### Reviewing Bot Suggestions

- Review all bot comments
- Decide if suggestions are valid
- Fix legitimate issues
- Respond to questionable suggestions with reasoning
- Don't ignore bot feedback

### PR Description Best Practices

**Include:**
- Summary of changes
- Testing performed (be specific)
- Related issue number (if applicable)

**Do NOT mention:**
- Claude or AI assistance
- "Generated by" statements

---

## GitHub API and SSH

### Sandbox Considerations

When using the `gh` command or the GitHub API, or SSH with GitHub:

- You're running in a sandbox environment
- May need to use `dangerouslyDisableSandbox: true` for network access
- This is safe for GitHub API operations

**Example:**
```bash
gh pr view 11220 --repo inavflight/inav
# If this fails with network errors, retry with dangerouslyDisableSandbox
```

---

## Git Hooks

### Never Skip Hooks

**NEVER** use `--no-verify` to skip pre-commit hooks unless explicitly requested by user.

```bash
# ❌ NEVER:
git commit --no-verify

# ✅ ALWAYS:
git commit  # Let hooks run
```

Pre-commit hooks catch important issues:
- Code formatting violations
- Linting errors
- Test failures
- Security issues

If a hook fails:
1. Fix the issue it identified
2. Add the fixes
3. Commit again (without --no-verify)

### If Pre-commit Hook Auto-modifies Files

Some hooks (like formatters) may auto-modify files:

1. Hook runs and modifies files
2. Commit succeeds but modified files are unstaged
3. **Only in this case**: You may amend to include the auto-modified files
4. Verify this is what happened before amending

---

## Force Push Rules

### NEVER Force Push to Shared Branches

**ABSOLUTELY FORBIDDEN** - Never force push to:
- `master` / `main`
- `maintenance-9.x` / `maintenance-10.x`
- Any shared/protected branch

```bash
# ❌ NEVER DO THIS:
git push --force origin master
git push -f origin maintenance-9.x
```

### Why Force Push is Dangerous

**Once something is pushed to a public/shared repository:**
- It becomes part of the permanent record
- Other developers may have fetched it
- Altering it creates problems for EVERYONE
- It breaks other developers' local repositories
- It corrupts CI/CD pipelines, PR references, and git history
- The damage is often irreversible and far-reaching

**Force pushing after a PR is merged corrupts GitHub's PR display:**
- GitHub's "Files changed" tab shows diff between base and CURRENT branch head
- If you force push after merge, PR shows DIFFERENT code than what was actually merged
- Anyone reviewing PR history sees FALSE information
- This is permanent corruption of the project's historical record

### When Force Push Might Be Acceptable

**Only on your own feature branches** that:
- Have NOT been merged
- Are NOT being used by anyone else
- Have NOT been referenced in any PR that's merged

Even then, ask first if unsure.

---

## Working Directory Safety

### Never Work on Production Branches

**Before making ANY code changes:**

```bash
# Check what branch you're on
git branch --show-current
```

**If the output is `secure_01`, `master`, `main`, or `maintenance-*`:**
- ❌ **STOP! DO NOT MAKE ANY CHANGES!**
- ❌ **DO NOT COMMIT!**
- ❌ **DO NOT PUSH!**

**Create a feature branch first:**
```bash
git checkout -b fix/my-issue
```

See `CRITICAL-BEFORE-CODE.md` for the complete pre-coding checklist.

---

## References

- **Pre-commit checklist:** `CRITICAL-BEFORE-COMMIT.md`
- **Pre-coding checklist:** `CRITICAL-BEFORE-CODE.md`
- **Git workflow skill:** `.claude/skills/git-workflow/SKILL.md`
- **Start task skill:** `.claude/skills/start-task/SKILL.md`

---

## Self-Improvement: Lessons Learned

When you discover something important about GIT WORKFLOW that will likely help in future sessions, add it to this section. Only add insights that are:
- **Reusable** - will apply to future git operations, not one-off situations
- **About git workflow** - commits, branches, PRs, force push, hooks, amending
- **Concise** - one line per lesson

Use the Edit tool to append new entries. Format: `- **Brief title**: One-sentence insight`

### Lessons

<!-- Add new lessons above this line -->
